// lib/src/auth_page.dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:dio/dio.dart';
import 'dart:ui';
import 'forgot_password_screen.dart';
import 'patient_dashboard.dart';
import 'doctor_dashboard.dart';
import 'doctor_onboarding_guard.dart'; // âœ… add import
import 'select_hospital_page.dart';
import '../services/api_service.dart';
import '../services/session_service.dart';

class AuthPage extends StatefulWidget {
  const AuthPage({super.key});

  @override
  State<AuthPage> createState() => _AuthPageState();
}

class _AuthPageState extends State<AuthPage> with TickerProviderStateMixin {
  bool isLogin = true;
  String role = 'patient';
  final _formKey = GlobalKey<FormState>();
  final _nameCtrl = TextEditingController();
  final _emailCtrl = TextEditingController();
  final _passwordCtrl = TextEditingController();
  final _hospitalCtrl = TextEditingController();
  bool loading = false;
  bool _passwordVisible = false;
  String? error;

  late AnimationController _animationController;
  late AnimationController _pulseController;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;
  late Animation<double> _scaleAnimation;
  late Animation<double> _pulseAnimation;

  final api = ApiService();

  @override
  void initState() {
    super.initState();

    // Main entrance animation
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1200),
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _animationController,
        curve: const Interval(0.0, 0.6, curve: Curves.easeOut),
      ),
    );

    _slideAnimation = Tween<Offset>(
      begin: const Offset(0, 0.5),
      end: Offset.zero,
    ).animate(
      CurvedAnimation(
        parent: _animationController,
        curve: const Interval(0.2, 0.8, curve: Curves.easeOutCubic),
      ),
    );

    _scaleAnimation = Tween<double>(begin: 0.8, end: 1.0).animate(
      CurvedAnimation(
        parent: _animationController,
        curve: const Interval(0.0, 0.6, curve: Curves.easeOutBack),
      ),
    );

    // Heartbeat pulse animation for medical cross
    _pulseController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 1500),
    )..repeat(reverse: true);

    _pulseAnimation = Tween<double>(begin: 1.0, end: 1.1).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );

    _animationController.forward();
  }

  @override
  void dispose() {
    _animationController.dispose();
    _pulseController.dispose();
    _nameCtrl.dispose();
    _emailCtrl.dispose();
    _passwordCtrl.dispose();
    _hospitalCtrl.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    if (!_formKey.currentState!.validate()) return;

    setState(() {
      loading = true;
      error = null;
    });

    try {
      Map<String, dynamic> data;

      if (isLogin) {
        data = await api.login(
          _emailCtrl.text.trim(),
          _passwordCtrl.text,
        );
      } else {
        data = await api.register(
          name: _nameCtrl.text.trim(),
          email: _emailCtrl.text.trim(),
          password: _passwordCtrl.text,
          role: role,
          hospitalName: role == 'doctor' ? _hospitalCtrl.text.trim() : null,
        );
      }

      final userMap = data['user'] ?? data['data'] ?? data['profile'];
      if (userMap == null) {
        throw Exception('Invalid auth response: missing user');
      }
      final user = Map<String, dynamic>.from(userMap as Map);

      final tokenValue = data['token'] ?? data['accessToken'] ?? data['jwt'] ?? '';
      final token = tokenValue.toString();
      final userRole = (user['role'] ?? role).toString();

      final session = context.read<SessionService>();
      await session.saveSession(token, user);

      if (!mounted) return;
      _goToDashboard(context, userRole);
    } on DioException catch (e) {
      final status = e.response?.statusCode;
      final body = e.response?.data;

      String msg = 'Request failed (${status ?? 'unknown'}).';
      if (body is Map<String, dynamic>) {
        msg = (body['message'] ?? body['error'] ?? body['detail'] ?? msg).toString();
      }

      setState(() => error = msg);
    } catch (e) {
      setState(() => error = 'Request failed: $e');
    } finally {
      if (mounted) {
        setState(() => loading = false);
      }
    }
  }

  void _goToDashboard(BuildContext context, String role) {
    if (role == 'doctor') {
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const DoctorOnboardingGuard()),
      );
    } else {
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const PatientDashboard()),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Colors.red.shade50.withOpacity(0.3),
              Colors.white,
              Colors.white,
            ],
          ),
        ),
        child: Stack(
          children: [
            // Subtle medical cross pattern background
            Positioned(
              top: -80,
              right: -80,
              child: Opacity(
                opacity: 0.03,
                child: Icon(
                  Icons.local_hospital,
                  size: 250,
                  color: Colors.red,
                ),
              ),
            ),
            Positioned(
              bottom: -120,
              left: -120,
              child: Opacity(
                opacity: 0.02,
                child: Icon(
                  Icons.medical_services_outlined,
                  size: 350,
                  color: Colors.red,
                ),
              ),
            ),

            // Main content
            SafeArea(
              child: Center(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(24),
                  child: FadeTransition(
                    opacity: _fadeAnimation,
                    child: SlideTransition(
                      position: _slideAnimation,
                      child: ScaleTransition(
                        scale: _scaleAnimation,
                        child: ConstrainedBox(
                          constraints: const BoxConstraints(maxWidth: 440),
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              // Medical Logo with Pulse Animation
                              AnimatedBuilder(
                                animation: _pulseAnimation,
                                builder: (context, child) {
                                  return Transform.scale(
                                    scale: _pulseAnimation.value,
                                    child: child,
                                  );
                                },
                                child: Container(
                                  width: 110,
                                  height: 110,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    gradient: LinearGradient(
                                      begin: Alignment.topLeft,
                                      end: Alignment.bottomRight,
                                      colors: [
                                        const Color(0xFFD32F2F),
                                        const Color(0xFFEF5350),
                                      ],
                                    ),
                                    boxShadow: [
                                      BoxShadow(
                                        color: Colors.red.withOpacity(0.3),
                                        blurRadius: 30,
                                        offset: const Offset(0, 15),
                                      ),
                                      BoxShadow(
                                        color: Colors.red.shade100,
                                        blurRadius: 20,
                                        offset: const Offset(0, -5),
                                      ),
                                    ],
                                  ),
                                  child: const Icon(
                                    Icons.local_hospital_rounded,
                                    size: 55,
                                    color: Colors.white,
                                  ),
                                ),
                              ),
                              const SizedBox(height: 32),

                              // Title
                              ShaderMask(
                                shaderCallback: (bounds) => LinearGradient(
                                  colors: [
                                    const Color(0xFFD32F2F),
                                    Colors.red.shade700,
                                  ],
                                ).createShader(bounds),
                                child: const Text(
                                  'Medtek',
                                  style: TextStyle(
                                    fontSize: 48,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.white,
                                    letterSpacing: 2,
                                  ),
                                ),
                              ),
                              const SizedBox(height: 8),

                              Text(
                                'Healthcare Management System',
                                style: TextStyle(
                                  fontSize: 16,
                                  color: Colors.grey.shade600,
                                  letterSpacing: 0.5,
                                  fontWeight: FontWeight.w400,
                                ),
                              ),
                              const SizedBox(height: 48),

                              // Card with subtle shadow
                              Container(
                                decoration: BoxDecoration(
                                  color: Colors.white,
                                  borderRadius: BorderRadius.circular(32),
                                  boxShadow: [
                                    BoxShadow(
                                      color: Colors.red.withOpacity(0.08),
                                      blurRadius: 40,
                                      offset: const Offset(0, 20),
                                    ),
                                    BoxShadow(
                                      color: Colors.black.withOpacity(0.05),
                                      blurRadius: 20,
                                      offset: const Offset(0, 10),
                                    ),
                                  ],
                                ),
                                padding: const EdgeInsets.all(32),
                                child: Column(
                                  children: [
                                    // Custom Toggle
                                    Container(
                                      padding: const EdgeInsets.all(6),
                                      decoration: BoxDecoration(
                                        color: Colors.grey.shade100,
                                        borderRadius: BorderRadius.circular(25),
                                        border: Border.all(
                                          color: Colors.grey.shade200,
                                        ),
                                      ),
                                      child: Row(
                                        children: [
                                          Expanded(
                                            child: _buildToggleButton(
                                              'Login',
                                              Icons.login_rounded,
                                              isLogin,
                                                  () => setState(() => isLogin = true),
                                            ),
                                          ),
                                          Expanded(
                                            child: _buildToggleButton(
                                              'Sign Up',
                                              Icons.person_add_rounded,
                                              !isLogin,
                                                  () => setState(() => isLogin = false),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                    const SizedBox(height: 32),

                                    // Form
                                    Form(
                                      key: _formKey,
                                      child: Column(
                                        children: [
                                          // Name field (signup only)
                                          if (!isLogin)
                                            _buildTextField(
                                              controller: _nameCtrl,
                                              label: 'Full Name',
                                              icon: Icons.person_outline_rounded,
                                              validator: (v) =>
                                              v == null || v.isEmpty ? 'Required' : null,
                                            ),

                                          if (!isLogin) const SizedBox(height: 16),

                                          // Email field
                                          _buildTextField(
                                            controller: _emailCtrl,
                                            label: 'Email Address',
                                            icon: Icons.email_outlined,
                                            keyboardType: TextInputType.emailAddress,
                                            validator: (v) {
                                              if (v == null || v.isEmpty) return 'Required';
                                              if (!v.contains('@')) return 'Invalid email';
                                              return null;
                                            },
                                          ),
                                          const SizedBox(height: 16),

                                          // Password field
                                          _buildTextField(
                                            controller: _passwordCtrl,
                                            label: 'Password',
                                            icon: Icons.lock_outline_rounded,
                                            obscureText: !_passwordVisible,
                                            suffixIcon: IconButton(
                                              icon: Icon(
                                                _passwordVisible
                                                    ? Icons.visibility_rounded
                                                    : Icons.visibility_off_rounded,
                                                color: Colors.grey.shade600,
                                              ),
                                              onPressed: () {
                                                setState(() =>
                                                _passwordVisible = !_passwordVisible);
                                              },
                                            ),
                                            validator: (v) => v == null || v.length < 4
                                                ? 'Min 4 characters'
                                                : null,
                                          ),

                                          // Role dropdown (signup only)
                                          if (!isLogin) ...[
                                            const SizedBox(height: 16),
                                            _buildDropdown(),
                                          ],

                                          // Hospital field (doctor signup only)
                                          if (!isLogin && role == 'doctor') ...[
                                            const SizedBox(height: 16),
                                            _buildTextField(
                                              controller: _hospitalCtrl,
                                              label: 'Hospital Name',
                                              icon: Icons.local_hospital_outlined,
                                              validator: (v) =>
                                              v == null || v.isEmpty ? 'Required' : null,
                                            ),
                                          ],

                                          // Forgot password (login only)
                                          if (isLogin) ...[
                                            const SizedBox(height: 12),
                                            Align(
                                              alignment: Alignment.centerRight,
                                              child: TextButton(
                                                onPressed: () {
                                                  Navigator.push(
                                                    context,
                                                    MaterialPageRoute(
                                                      builder: (_) =>
                                                      const ForgotPasswordScreen(),
                                                    ),
                                                  );
                                                },
                                                child: const Text(
                                                  'Forgot Password?',
                                                  style: TextStyle(
                                                    color: Color(0xFFD32F2F),
                                                    fontWeight: FontWeight.w600,
                                                    fontSize: 14,
                                                  ),
                                                ),
                                              ),
                                            ),
                                          ],

                                          const SizedBox(height: 24),

                                          // Error message
                                          if (error != null) ...[
                                            Container(
                                              padding: const EdgeInsets.all(16),
                                              decoration: BoxDecoration(
                                                color: Colors.red.shade50,
                                                borderRadius: BorderRadius.circular(16),
                                                border: Border.all(
                                                  color: Colors.red.shade200,
                                                ),
                                              ),
                                              child: Row(
                                                children: [
                                                  Icon(
                                                    Icons.error_outline_rounded,
                                                    color: Colors.red.shade700,
                                                    size: 22,
                                                  ),
                                                  const SizedBox(width: 12),
                                                  Expanded(
                                                    child: Text(
                                                      error!,
                                                      style: TextStyle(
                                                        color: Colors.red.shade700,
                                                        fontSize: 14,
                                                      ),
                                                    ),
                                                  ),
                                                ],
                                              ),
                                            ),
                                            const SizedBox(height: 20),
                                          ],

                                          // Submit button
                                          SizedBox(
                                            width: double.infinity,
                                            height: 58,
                                            child: ElevatedButton(
                                              onPressed: loading ? null : _submit,
                                              style: ElevatedButton.styleFrom(
                                                backgroundColor: const Color(0xFFD32F2F),
                                                foregroundColor: Colors.white,
                                                shape: RoundedRectangleBorder(
                                                  borderRadius: BorderRadius.circular(18),
                                                ),
                                                elevation: 3,
                                                shadowColor: Colors.red.withOpacity(0.3),
                                              ),
                                              child: loading
                                                  ? const SizedBox(
                                                height: 24,
                                                width: 24,
                                                child: CircularProgressIndicator(
                                                  strokeWidth: 2.5,
                                                  color: Colors.white,
                                                ),
                                              )
                                                  : Row(
                                                mainAxisAlignment:
                                                MainAxisAlignment.center,
                                                children: [
                                                  Icon(
                                                    isLogin
                                                        ? Icons.login_rounded
                                                        : Icons.person_add_rounded,
                                                    size: 22,
                                                  ),
                                                  const SizedBox(width: 8),
                                                  Text(
                                                    isLogin
                                                        ? 'Login'
                                                        : 'Create Account',
                                                    style: const TextStyle(
                                                      fontSize: 18,
                                                      fontWeight: FontWeight.bold,
                                                      letterSpacing: 0.5,
                                                    ),
                                                  ),
                                                ],
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ),
                              ),

                              const SizedBox(height: 24),

                              // Privacy notice
                              if (!isLogin)
                                Padding(
                                  padding: const EdgeInsets.symmetric(horizontal: 32),
                                  child: Row(
                                    mainAxisAlignment: MainAxisAlignment.center,
                                    children: [
                                      Icon(
                                        Icons.shield_outlined,
                                        size: 16,
                                        color: Colors.grey.shade600,
                                      ),
                                      const SizedBox(width: 8),
                                      Expanded(
                                        child: Text(
                                          'Your health data is secure and HIPAA compliant',
                                          textAlign: TextAlign.center,
                                          style: TextStyle(
                                            fontSize: 12,
                                            color: Colors.grey.shade600,
                                            height: 1.5,
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildToggleButton(String text, IconData icon, bool isActive, VoidCallback onTap) {
    return GestureDetector(
      onTap: onTap,
      child: AnimatedContainer(
        duration: const Duration(milliseconds: 300),
        curve: Curves.easeInOut,
        padding: const EdgeInsets.symmetric(vertical: 14),
        decoration: BoxDecoration(
          color: isActive ? const Color(0xFFD32F2F) : Colors.transparent,
          borderRadius: BorderRadius.circular(20),
          boxShadow: isActive
              ? [
            BoxShadow(
              color: Colors.red.withOpacity(0.3),
              blurRadius: 12,
              offset: const Offset(0, 4),
            ),
          ]
              : [],
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(
              icon,
              size: 18,
              color: isActive ? Colors.white : Colors.grey.shade700,
            ),
            const SizedBox(width: 6),
            Text(
              text,
              style: TextStyle(
                color: isActive ? Colors.white : Colors.grey.shade700,
                fontWeight: FontWeight.bold,
                fontSize: 15,
                letterSpacing: 0.3,
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required IconData icon,
    bool obscureText = false,
    Widget? suffixIcon,
    TextInputType? keyboardType,
    String? Function(String?)? validator,
  }) {
    return TextFormField(
      controller: controller,
      obscureText: obscureText,
      keyboardType: keyboardType,
      style: const TextStyle(fontSize: 16, color: Colors.black87),
      decoration: InputDecoration(
        labelText: label,
        labelStyle: TextStyle(color: Colors.grey.shade600),
        prefixIcon: Icon(icon, color: const Color(0xFFD32F2F), size: 22),
        suffixIcon: suffixIcon,
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: Colors.grey.shade300),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: Colors.grey.shade300),
        ),
        focusedBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: const BorderSide(color: Color(0xFFD32F2F), width: 2),
        ),
        errorBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(16),
          borderSide: BorderSide(color: Colors.red.shade400),
        ),
        filled: true,
        fillColor: Colors.grey.shade50,
        contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
      ),
      validator: validator,
    );
  }

  Widget _buildDropdown() {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 4),
      decoration: BoxDecoration(
        color: Colors.grey.shade50,
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: Colors.grey.shade300),
      ),
      child: DropdownButtonFormField<String>(
        value: role,
        dropdownColor: Colors.white,
        decoration: const InputDecoration(
          border: InputBorder.none,
          icon: Icon(Icons.badge_outlined, color: Color(0xFFD32F2F), size: 22),
          labelText: 'Select Role',
          labelStyle: TextStyle(color: Colors.grey),
        ),
        style: const TextStyle(color: Colors.black87, fontSize: 16),
        items: const [
          DropdownMenuItem(
            value: 'patient',
            child: Text('Patient'),
          ),
          DropdownMenuItem(
            value: 'doctor',
            child: Text('Doctor'),
          ),
        ],
        onChanged: (v) {
          setState(() => role = v ?? 'patient');
        },
      ),
    );
  }
}
